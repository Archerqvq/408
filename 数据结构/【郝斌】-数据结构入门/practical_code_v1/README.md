Based on Haobin, and some subtly changes made by myself